tinymce.PluginManager.add('highlight_text', function(editor, url) {
    editor.addButton('highlight_text', {
    	text: 'highlight',
        icon: false,
        tooltip: 'highlight text',
        stateSelector: 'span[data-role="highlight"]:not([data-mce-object],[data-mce-placeholder])',
        onclick: function() {
        	var content = editor.selection.getContent();
        	var node = editor.selection.getNode();
        	if(content == "") {
        		if(node.nodeName == "SPAN" && $(node).attr("data-role") == "highlight") {
        			$(node).replaceWith($(node).html());
        		}
        		return false;
        	}
        	if(node.nodeName != "SPAN" || $(node).attr("data-role") != "highlight") {
        		editor.selection.setNode(editor.dom.create('span',{"data-role":"highlight"}, content));
        		removeChildHighlight($(node).children("span[data-role='highlight']"));
        	} else {
        		var nodeHtml = $(node).html();
        		if(content == nodeHtml) {
        			$(node).replaceWith($(node).html());
        		} else if(content.length < nodeHtml.length){
        			editor.selection.setNode(editor.dom.create('span',{"data-role":"highlight"}, content));
        			$(node).replaceWith($(node).html());
        		} else if(content.length > nodeHtml.length){
       				editor.selection.setNode(editor.dom.create('span',{"data-role":"highlight"}, content));
       				removeChildHighlight($(node).children("span[data-role='highlight']"));
        		}
        	}
        }
    });
});
function removeChildHighlight(node) {
	$(node).find("span[data-role='highlight']").each(function(){
		$(this).replaceWith($(this).html());
	});
}