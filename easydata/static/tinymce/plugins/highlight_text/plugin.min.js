tinymce.PluginManager.add('highlight_text', function(editor, url) {
    editor.addButton('highlight_text', {
    	text: 'highlight',
        icon: false,
        tooltip: 'highlight text',
        stateSelector: 'span[data-role="highlight"]:not([data-mce-object],[data-mce-placeholder])',
        onclick: function() {
        	var content = editor.selection.getContent();
        	var node = editor.selection.getNode();
        	if(node.nodeName != "SPAN" && $(node).attr("data-role") != "highlight") {
        		editor.selection.setNode(editor.dom.create('span',{"data-role":"highlight"}, content)); 
        	} else {
        		var nodeHtml = $(node).html();
        		if(content == nodeHtml) {
        			$(node).removeAttr("data-role");
        		} else {
        			$(node).removeAttr("data-role");
        			editor.selection.setNode(editor.dom.create('span',{"data-role":"highlight"}, content));
        			        			
        		}
        	}
        }
    });
});