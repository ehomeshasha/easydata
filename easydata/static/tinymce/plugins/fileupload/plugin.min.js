tinymce.PluginManager.add('fileupload', function(editor, url) {
    // Add a button that opens a window
    editor.addButton('fileupload', {
        icon: 'browse',
        tooltip: 'upload file',
        onclick: function() {
            // Open window
            editor.windowManager.open({
                title: 'upload file',
                body: [
                   {name: 'upload_file', type: 'filepicker', filetype: 'file', label: 'Source', autofocus: true},
                   {name: 'title', type: 'textbox', label: 'File description'},
                ],
                onsubmit: function(e) {
                	var upload_file = $("#upload_file");
                	var mimetype = upload_file.attr("data-mimetype");
                	var name = upload_file.attr("data-name");
                	var url = e.data.upload_file;
                	var title = e.data.title
                	
                	
                	editor.insertContent("<a data-role='upload' href='/download_file/?filepath="+url+"&mimetype="+mimetype+"' title='"+title+"'>"+name+"</a>");
                }
            });
        }
    });
});